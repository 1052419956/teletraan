{% load utils %}

<div id="envScheduleId" class="collapse in panel-body">
    <div class="container-fluid">
        <form id="envCapacityFormId" class="form-horizontal" role="form">
            <table id="sessionTable" class="table">
            <tr>
                <th class="col-md-1">Session #</th>
                <th class="col-md-2">Number of Hosts</th>
                <th class="col-md-2">Cooldown Period</th>
                <th class="col-md-4"></th>
            </tr>
            <tr>
                <td>Final</td>
                <td class="hostNumber">
                     <div class="input-group">
                        <input disabled type="text" class="form-control">
                        <span class="input-group-addon">hosts</span>
                    </div>
                      <div class="input-group">
                    
                    </div>
                </td>
                <td class="cooldownTime">
                    <div class="input-group">
                        <input disabled type="text" class="form-control">
                        <span class="input-group-addon">minutes</span>
                    </div>
                </td>
                <td class="text-right">
                    <!-- <button type="button" class="btn btn-danger">Remove</button> -->
                </td>
            </tr>

            </table>
            <div>Note that the above sessions are run before running the rest of the total hosts</div>
            {% csrf_token %}
        </form>

        <button type="button" id="addSessionBtn" class="btn btn-default">Add another session</button>
    </div>
</div>

<div class="panel-footer clearfix">
    <div class="pull-right">
        <button id="saveEnvScheduleBtnId" class="btn btn-default"
                data-loading-text="Saving...">
            <span class="glyphicon glyphicon-refresh"></span> Save
        </button>
        <button id="resetEnvScheduleBtnId" class="btn btn-default"
                data-loading-text="Reloading...">
            <span class="glyphicon glyphicon-refresh"></span> Reset
        </button>
    </div>
</div>

<script type="text/javascript">
    var currentSessionNumber = 0;

    // on document load + if schedule exists 
    $(document).ready(function() {
        {% if schedule %} 
            var cooldownTimes = "{{ schedule.cooldownTimes }}";
            var hostNumbers = "{{ schedule.hostNumbers }}";

            if (cooldownTimes != "" && hostNumbers != "") {
            // or else it counts it as one!! 
                var timesArray = cooldownTimes.split(",");
                var numbersArray = hostNumbers.split(",");
            }
            currentSessionNumber = {{ schedule.totalSessions }};
            // console.log("currentSessionNumber");
            // console.log(currentSessionNumber);
            // console.log(numbersArray);
            var i;
            for (i = 1; i<=currentSessionNumber; i++) {
                $('#sessionTable tr:last').before('<tr><td class="sessionNumber" id=sessionNumber'+i+'>'+i+'</td><td class="hostNumber"><div class="input-group"><input value='+numbersArray[i-1]+' type="text" class="form-control"><span class="input-group-addon">hosts</span></div></div></td><td class="cooldownTime"><div class="input-group"><input value='+timesArray[i-1]+' type="text" class="form-control"><span class="input-group-addon">minutes</span></div></td><td class="text-right"><button id="removeBtn" type="button" class="btn btn-danger">Remove</button></td></tr>');
            }
        // {% else %}
        //     console.log("schedule is null")
        //     currentSessionNumber = 0;
        {% endif %}
    })

    $("#addSessionBtn").click(function() {
        currentSessionNumber=currentSessionNumber+1;
        $('#sessionTable tr:last').before('<tr><td class="sessionNumber" id=sessionNumber'+currentSessionNumber+'>'+currentSessionNumber+'</td><td class="hostNumber"><div class="input-group"><input type="text" class="form-control"><span class="input-group-addon">hosts</span></div></div></td><td class="cooldownTime"><div class="input-group"><input type="text" class="form-control"><span class="input-group-addon">minutes</span></div></td><td class="text-right"><button id="removeBtn" type="button" class="btn btn-danger">Remove</button></td></tr>');
    });

    
     
    // $("#sessionTable tr").not(':first').each(function() { // try  to start from 2nd row 
    //         var hostNumber = $(this).find(".hostNumber input").val();

    //         var cooldownTime = $(this).find(".cooldownTime input").val();
    //         if (hostNumbers == "") {
    //                 hostNumbers = hostNumber;
    //             } else {
    //                 hostNumbers = hostNumbers + "," + hostNumber;
    //             }
    //             if (cooldownTimes == "") {
    //                 cooldownTimes = cooldownTime;
    //             } else {
    //                 cooldownTimes = cooldownTimes +  "," + cooldownTime;
    //             }
    //         });


    $("#sessionTable").on("click", "#removeBtn", function () {
        $(this).closest('tr').remove();
        currentSessionNumber = currentSessionNumber-1;
        counter = 1; 
        $("#sessionTable tr").not(':first').each(function() {
            var number = $(this).find(".sessionNumber");
            number.text(counter);
            counter=counter+1;
        })
    });

    $("#saveEnvScheduleBtnId").click(function() {
        var schedule = '{{ env.schedule }}';
        console.log(currentSessionNumber);
        var cooldownTimes = "";
        var hostNumbers= ""; 
        $("#sessionTable tr").not(':first').not(':last').each(function() { // try  to start from 2nd row 
            var hostNumber = $(this).find(".hostNumber input").val();

            var cooldownTime = $(this).find(".cooldownTime input").val();
            if (hostNumbers == "") {
                hostNumbers = hostNumber;
            } else {
                hostNumbers = hostNumbers + "," + hostNumber ;
            }
            if (cooldownTimes == "") {
                cooldownTimes = cooldownTime;
            } else {
                cooldownTimes = cooldownTimes +  "," + cooldownTime;
            }
        });
        console.log(cooldownTimes);
        console.log(hostNumbers);
        console.log(currentSessionNumber);

        var btn = $(this);

        $.ajax({
            type: 'POST',
            url: '/env/{{ env.envName }}/{{ env.stageName }}/update_schedule/',
            data: {'csrfmiddlewaretoken': '{{csrf_token}}',
                   'cooldownTimes': cooldownTimes, 
                   'hostNumbers': hostNumbers,
                   'totalSessions': currentSessionNumber}, 
            dataType: "json",
            beforeSend: function () {
                // btn.button('loading');
            },
            success: function (data) {
                if(data != null && data.success == false) {
                    $('#errorBannerId').append(data.error);
                    $('#errorBannerId').show();
                } else {
                    $("#envScheduleId").parent().html(data.html);
                    $('#errorBannerId').empty().hide();
                }
                // btn.button('reset');
            },
            error: function (data) {
                $('#errorBannerId').append(data.responseText);
                $('#errorBannerId').show();
            }
        }); 
    });

    //if saved more create schedule --> 
    //if deleted everything --> delete schedule and reference to schedule from deploys
    //do you not know how many agents until deploy actually starts running? 

    

</script>
